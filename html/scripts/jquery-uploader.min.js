var Uploader={};Uploader.Input=function(e){var t=this;return this.attachOnChange=function(n){return $(e).on("change",function(t){for(var o=t.originalEvent.target||t.originalEvent.srcElement,r=o.files,i=0;i<r.length;i++)n.renderItem(r[i]);$(e).val("")}),t},this.hide=function(){return $(e).hide(),t},this.getHtmlElement=function(){return e},this.getName=function(){var t=$(e).attr("name");return $(e).removeAttr("name"),t},t},Uploader.Preview=function(e,t){var n=this;this.counter,this.htmlElements,this.error=e.error,this.render=e.render,this.onRenderEnd=e.onRenderEnd,this.beforeCancel=e.beforeCancel,this.upload=e.upload,this.maxFiles=e.maxFiles,this.minFileSize=e.minFileSize,this.maxFileSize=e.maxFileSize,this.errorMessages=e.errorMessages,this.allowedMimeTypes=e.allowedMimeTypes,this.allowedExtensions=e.allowedExtensions,this.forbiddenMimeTypes=e.forbiddenMimeTypes,this.forbiddenExtensions=e.forbiddenExtensions,this.renderContainer=function(){return n.htmlElements=n.render(),n},this.renderItem=function(e){var t=n.validateFile(e);t?"function"==typeof n.error&&n.error(t):("number"!=typeof n.counter?n.counter=1:n.counter++,n.handleItem(e))},this.validateFile=function(e){var t=new Uploader.Validator,o=t.validateFileExtension(e,{allowedExtensions:n.allowedExtensions,forbiddenExtensions:n.forbiddenExtensions},n.errorMessages);return o||(o=t.validateFileMimeType(e,{allowedMimeTypes:n.allowedMimeTypes,forbiddenMimeTypes:n.forbiddenMimeTypes},n.errorMessages)),o||(o=t.validateFileSize(e,n.maxFileSize,n.minFileSize,n.errorMessages)),o||(o=t.validateFilesNumber(n.maxFiles,n.counter,n.errorMessages)),o},this.handleItem=function(e){var t=null,o=null,r=null,i=null,a=$(n.htmlElements.item).clone(),l=n.generatePreview(e);$(n.htmlElements.container).append(a);for(var s in n.htmlElements)if("container"!==s&&"item"!==s)switch(s){case"preview":i=$(n.htmlElements[s]).clone(),$(a).append(i.append(l));break;case"upload":t=$(n.htmlElements[s]).clone(),$(a).append(t);break;case"cancel":o=$(n.htmlElements[s]).clone(),$(a).append(o);break;case"progress":r=$(n.htmlElements[s]).clone(),$(a).append(r);break;default:$(a).append($(n.htmlElements[s]).clone())}n.attachUploadEvent(t,o,e,r,a),n.onRenderEnd(a)},this.generatePreview=function(e){var t,o=new Uploader.Html,r=new Uploader.Thumbnail;switch(n.getHtmlThumbnailTagForFile(e)){case o.TAG_IMG:t=r.getImage(e);break;case o.TAG_VIDEO:t=r.getVideo(e);break;default:t=r.getDefault(e)}return t},this.getHtmlThumbnailTagForFile=function(e){var t=e.type;if("string"!=typeof t)throw new Error("Invalid mime type for preview");var n=(new Uploader.Html).TAG_DIV;return-1!=t.indexOf("image")&&(n=(new Uploader.Html).TAG_IMG),-1!=t.indexOf("video")&&(n=(new Uploader.Html).TAG_VIDEO),n},this.attachUploadEvent=function(e,o,r,i,a){var l;$(e).on("click",function(o){l=new Uploader.Request(t.getName(),r,n.upload,e,i),o.preventDefault()}),$(o).on("click",function(e){"undefined"!=typeof l&&l.abort(),n.beforeCancel(a),$(a).remove(),n.counter--,e.preventDefault()})}},Uploader.Request=function(e,t,n,o,r){var i=new XMLHttpRequest;i.open("POST",n.url),i.onloadstart=function(e){n.onLoadStart(e,t,o)},i.onabort=function(e){n.onAbort(e,t,o)},i.onerror=function(e){n.onError(e,t,o)},i.onload=function(e){n.onLoad(e,t,o)},i.onloadend=function(e){200!=i.status?n.onError(e,t,o):n.onSuccess(e,t,o),n.onLoadEnd(e,t,o)},i.ontimeout=function(e){n.onTimeout(e,t,o)},i.onprogress=function(e){if(e.lengthComputable){var i=e.loaded/e.total*100;$(r).attr("value",i)}n.onProgress(e,t,o)};var a=new FormData;return a.append(e,t),a=n.beforeSend(a,t,o),i.send(a),i},Uploader.Thumbnail=function(){this.getImage=function(e){var t=(new Uploader.Html).getImg(),n=new FileReader;return n.onloadend=function(){t.src=n.result},n.readAsDataURL(e),t},this.getVideo=function(e){var t=new(Uploader.Html().getVideo),n=new FileReader;return n.onloadend=function(){t.src=n.result},n.readAsDataURL(e),t},this.getDefault=function(e){return e.name},this.filterParams=function(e){var t=new Uploader.Html;return typeof e!==t.TYPE_OBJECT&&(e={}),typeof e.container!==t.TYPE_OBJECT&&(e.container=t.getUl(),$("#preview").html(e.container)),typeof e.item!==t.TYPE_OBJECT&&(e.item=t.getLi()),typeof e.preview!==t.TYPE_OBJECT&&(e.preview=t.getDiv()),typeof e.progress!==t.TYPE_OBJECT&&(e.progress=t.getProgress()),typeof e.upload!==t.TYPE_OBJECT&&(e.upload=t.getButton(),e.upload.setAttribute("class","upload"),$(e.upload).text("Upload")),typeof e.cancel!==t.TYPE_OBJECT&&(e.cancel=t.getButton(),e.cancel.setAttribute("class","cancel"),$(e.cancel).text("Cancel")),e}},Uploader.Validator=function(){var e=function(e){var t="",n="";for(index in e)isNaN(e[index])?t+=e[index]:n+=e[index];if(n=parseInt(n),t)switch(t.toUpperCase()){case"B":break;case"KB":n=1024*n;break;case"MB":n=1024*n*1024;break;case"GB":n=1024*n*1024*1024;break;case"TB":n=1024*n*1024*1024*1024;break;case"PB":n=1024*n*1024*1024*1024*1024}return n};this.validateFileSize=function(t,n,o,r){var i=null;if("string"==typeof n){var n=e(n);t.size>n&&(i="object"==typeof r&&"string"!=typeof r.tooLargeFile&&r.tooLargeFile?r.tooLargeFile:"Your file is too large.")}if("string"==typeof o){var o=e(o);t.size<o&&(i="object"==typeof r&&"string"!=typeof r.tooSmallFile&&r.tooSmallFile?r.tooSmallFile:"Your file is too small.")}return i},this.validateFileMimeType=function(e,t,n){var o=null,r=t.allowedMimeTypes,i=t.forbiddenMimeTypes;return"object"==typeof r&&r.length>0&&-1===r.indexOf(e.type)&&(o="object"==typeof n&&"string"!=typeof n.forbidden&&n.forbidden?n.forbidden:"File is forbidden."),"object"==typeof i&&i.length>0&&-1!==i.indexOf(e.type)&&(o="object"==typeof n&&"string"!=typeof n.forbidden&&n.forbidden?n.forbidden:"File is forbidden."),o},this.validateFilesNumber=function(e,t,n){var o=null;return"number"==typeof e&&t>=e&&(o="object"==typeof n&&"string"!=typeof n.tooManyFiles&&n.tooManyFiles?n.tooManyFiles:"You cannot upload more files."),o},this.validateFileExtension=function(e,t,n){var o=null,r=t.allowedExtensions,i=t.forbiddenExtensions;if("object"==typeof r&&r.length>0){var a=e.name.split(".").pop();-1===r.indexOf(a)&&(o="object"==typeof n&&"string"!=typeof n.forbidden&&n.forbidden?n.forbidden:"File is forbidden.")}if("object"==typeof i&&i.length>0){var a=e.name.split(".").pop();-1!==i.indexOf(a)&&(o="object"==typeof n&&"string"!=typeof n.forbidden&&n.forbidden?n.forbidden:"File is forbidden.")}return o}},Uploader.Filter=function(){var e=this;this.filterParams=function(t){return"object"!=typeof t&&(t={}),"object"!=typeof t.browser&&(t.browser={}),"object"!=typeof t.preview&&(t.preview={}),t.browser=e.filterBrowserParams(t.browser),t.preview=e.filterPreviewParams(t.preview),t},this.filterBrowserParams=function(e){return"function"!=typeof e.render&&(e.render=function(){var e=document.createElement("button");return $(e).text("Select file"),e}),"function"!=typeof e.onDrop&&(e.onDrop=function(){}),"function"!=typeof e.onClick&&(e.onClick=function(){}),"function"!=typeof e.onDragOver&&(e.onDragOver=function(){}),"function"!=typeof e.onDragLeave&&(e.onDragLeave=function(){}),"function"!=typeof e.onDragEnter&&(e.onDragEnter=function(){}),"function"!=typeof e.beforeCancel&&(e.beforeCancel=function(){}),e},this.filterPreviewParams=function(e){return"object"!=typeof e.upload&&(e.upload={}),"function"!=typeof e.onRenderEnd&&(e.onRenderEnd=function(){}),"function"!=typeof e.upload.onLoadStart&&(e.upload.onLoadStart=function(){}),"function"!=typeof e.upload.onProgress&&(e.upload.onProgress=function(){}),"function"!=typeof e.upload.onAbort&&(e.upload.onAbort=function(){}),"function"!=typeof e.upload.onError&&(e.upload.onError=function(){}),"function"!=typeof e.upload.onSuccess&&(e.upload.onSuccess=function(){}),"function"!=typeof e.upload.onLoad&&(e.upload.onLoad=function(){}),"function"!=typeof e.upload.onLoadEnd&&(e.upload.onLoadEnd=function(){}),"function"!=typeof e.upload.onTimeout&&(e.upload.onTimeout=function(){}),"function"!=typeof e.upload.beforeSend&&(e.upload.beforeSend=function(e){return e}),"string"!=typeof e.upload.url&&(e.upload.url="/upload"),"undefined"!=typeof e.maxFiles&&isNaN(e.maxFiles)&&(e.maxFiles=1),e}},Uploader.Browser=function(e){var t=this;this.htmlElement,this.onDrop=e.onDrop,this.onClick=e.onClick,this.onDragOver=e.onDragOver,this.onDragEnter=e.onDragEnter,this.onDragLeave=e.onDragLeave,this.render=function(){return t.htmlElement=e.render(),t},this.attachOnDrop=function(e){return $(t.htmlElement).on("drop",function(n){n.preventDefault();for(var o=0;o<n.originalEvent.dataTransfer.files.length;o++)e.renderItem(n.originalEvent.dataTransfer.files[o]);t.onDrop(this,n)}),t},this.attachOnDragEnter=function(){return $(t.htmlElement).on("dragenter",function(e){e.stopPropagation(),e.preventDefault(),t.onDragEnter(this,e)}),t},this.attachOnDragOver=function(){return $(t.htmlElement).on("dragover",function(e){e.stopPropagation(),e.preventDefault(),t.onDragOver(this,e)}),t},this.attachOnDragLeave=function(){return $(t.htmlElement).on("dragleave",function(e){e.stopPropagation(),e.preventDefault(),t.onDragLeave(this,e)}),t},this.attachOnClick=function(e){return $(t.htmlElement).on("click",function(n){n.preventDefault(),$(e.getHtmlElement()).trigger("click"),t.onClick(this,n)}),t}},Uploader.Html=function(){var e=this;this.TAG_UL="ul",this.TAG_LI="li",this.TAG_IMG="img",this.TAG_DIV="div",this.TAG_SPAN="span",this.TAG_VIDEO="video",this.TAG_BUTTON="button",this.TAG_PROGRESS="progress",this.TYPE_OBJECT="object",this.TYPE_STRING="string",this.TYPE_NUMBER="number",this.TYPE_UNDEFINED="undefined",this.getUl=function(){return document.createElement(e.TAG_UL)},this.getLi=function(){return document.createElement(e.TAG_LI)},this.getImg=function(){return document.createElement(e.TAG_IMG)},this.getDiv=function(){return document.createElement(e.TAG_DIV)},this.getSpan=function(){return document.createElement(e.TAG_SPAN)},this.getVideo=function(){return document.createElement(e.TAG_VIDEO)},this.getButton=function(){return document.createElement(e.TAG_BUTTON)},this.getProgress=function(){var t=document.createElement(e.TAG_PROGRESS);return $(t).attr("value","0").attr("max","100"),t}},$(document).ready(function(){jQuery.fn.upload=function(e){var t=(new Uploader.Filter).filterParams(e),n=new Uploader.Browser(t.browser),o=new Uploader.Input(this[0],t),r=new Uploader.Preview(t.preview,o);o.hide().attachOnChange(r),n.render(),n.attachOnClick(o),n.attachOnDrop(r),n.attachOnDragEnter(),n.attachOnDragOver(),n.attachOnDragLeave(),r.renderContainer()}});